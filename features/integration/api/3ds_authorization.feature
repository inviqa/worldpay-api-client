Feature: A payment authorization request is made against the Worldpay payment gateway

    Notes: the encryptedData value in the follow scenario is representative of the below test card details:
    - card number: 444333322221111
    - cvc: 123
    - expiry month: 5
    - expiry year: 2025
    - card holder name: 3D - this value is going to always trigger a test 3DS response from the API

    Scenario: Payment authorization with dynamic3DS and positive dynamic3DSOverride triggers a 3DS reply
        When I authorize the following payment
            | merchantCode        | SESSIONECOM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | orderCode           | 42796999                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
            | description         | some description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
            | currencyCode        | GBP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | value               | 15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | encryptedData       | eyJhbGciOiJSU0ExXzUiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoiMSIsImNvbS53b3JsZHBheS5hcGlWZXJzaW9uIjoiMS4wIiwiY29tLndvcmxkcGF5LmxpYlZlcnNpb24iOiIxLjAuMSIsImNvbS53b3JsZHBheS5jaGFubmVsIjoiamF2YXNjcmlwdCJ9.UH4Y2v2KbW2DdvRD7YHdTIJUggsvXII7ELtHR8j2DlcCrGOEMNct6ldhyXaPyFJzAzHT36egehOjOTEwkFLJdmpow_HF1J0gpbzptbGA8sM2m7s6jcPmrTbKFefm__4J2DjMXgky1ePK4dLUBVnA3VlElSykSUi1IqCoJwP7jVyIG6i02mIg7FNRAeoV41KqTtKzCkgm7mXKtymUUZnLlX4RGnuyHDA6qFCN1lAOods_z55bSfwAKaJv6Yv0VWuHRpzFS1UjUcPOC6ykCDD6avLzyNldMVD2n52nw6JGwaB_0R0QdbcGC_apbqxnd7Uh6jSkN5vRxzR_6x9cvSUM7A.SEuHD3wTOA9m16DZ.DyOT__yg46O6tXPjO1qa6LxUHg-Q2EubPpSgw4kwr0v79_4rouOa3PN4n-638nTi0qd07EEn0RfKzW8sbBbxiJJP73fUtwdp5N4_frt72u6DSjnXQnV85Nkx9p5zapOvpXoNZ18W02moKw._YWDBgZNMCZiqsJFshUhQg |
            | firstName           | Tim                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | lastName            | Webster                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | address1            | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | address2            | Braford Gardens                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | address3            | Shenley Brook End                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | postalCode          | MK137QJ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | city                | Milton Keynes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
            | state               | Buckingamshire                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
            | countryCode         | GB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | shopperIPAddress    | 123.123.123.123                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | sessionId           | 0215ui8ib1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | email               | lpanainte+test@inviqa.com                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | acceptHeader        | text/html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | userAgentHeader     | Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | dynamic3DS          | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
            | dynamic3DSOverride  | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
            | RGProfileID         | 201477                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | shippingMethod      | UK Next Day                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | checkoutMethod      | Registered                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | orderSource         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | ageOfAccount        | 4.5678                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | timeSinceLastOrder  | 3.4567                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | numberPurchases     | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | productRisk         | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | numberStyles        | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberSkus          | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberUnits         | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberHighRiskUnits | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
        Then I should receive a 3d secure response
        And the response should reference the "42796999" order code
        And the response should reference a valid "paRequest" value
        And the response should reference the following issuerURL: "https://secure-test.worldpay.com/jsp/test/shopper/ThreeDResponseSimulator.jsp?orderCode=42796999"

    Scenario: Payment authorization with dynamic3DS and negative dynamic3DSOverride triggers a normal authorized reply
        When I authorize the following payment
            | merchantCode        | SESSIONECOM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | orderCode           | 42796959                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
            | description         | some description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
            | currencyCode        | GBP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | value               | 15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | encryptedData       | eyJhbGciOiJSU0ExXzUiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoiMSIsImNvbS53b3JsZHBheS5hcGlWZXJzaW9uIjoiMS4wIiwiY29tLndvcmxkcGF5LmxpYlZlcnNpb24iOiIxLjAuMSIsImNvbS53b3JsZHBheS5jaGFubmVsIjoiamF2YXNjcmlwdCJ9.UH4Y2v2KbW2DdvRD7YHdTIJUggsvXII7ELtHR8j2DlcCrGOEMNct6ldhyXaPyFJzAzHT36egehOjOTEwkFLJdmpow_HF1J0gpbzptbGA8sM2m7s6jcPmrTbKFefm__4J2DjMXgky1ePK4dLUBVnA3VlElSykSUi1IqCoJwP7jVyIG6i02mIg7FNRAeoV41KqTtKzCkgm7mXKtymUUZnLlX4RGnuyHDA6qFCN1lAOods_z55bSfwAKaJv6Yv0VWuHRpzFS1UjUcPOC6ykCDD6avLzyNldMVD2n52nw6JGwaB_0R0QdbcGC_apbqxnd7Uh6jSkN5vRxzR_6x9cvSUM7A.SEuHD3wTOA9m16DZ.DyOT__yg46O6tXPjO1qa6LxUHg-Q2EubPpSgw4kwr0v79_4rouOa3PN4n-638nTi0qd07EEn0RfKzW8sbBbxiJJP73fUtwdp5N4_frt72u6DSjnXQnV85Nkx9p5zapOvpXoNZ18W02moKw._YWDBgZNMCZiqsJFshUhQg |
            | firstName           | Tim                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | lastName            | Webster                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | address1            | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | address2            | Braford Gardens                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | address3            | Shenley Brook End                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | postalCode          | MK137QJ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | city                | Milton Keynes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
            | state               | Buckingamshire                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
            | countryCode         | GB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | shopperIPAddress    | 123.123.123.123                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | sessionId           | 0215ui8ib1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | email               | lpanainte+test@inviqa.com                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | acceptHeader        | text/html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | userAgentHeader     | Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | dynamic3DS          | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
            | dynamic3DSOverride  | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | RGProfileID         | 201477                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | shippingMethod      | UK Next Day                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | checkoutMethod      | Registered                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | orderSource         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | ageOfAccount        | 4.5678                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | timeSinceLastOrder  | 3.4567                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | numberPurchases     | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | productRisk         | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | numberStyles        | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberSkus          | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberUnits         | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberHighRiskUnits | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
        Then I should receive an authorised response
        And the response should be successful
        And the response should reference the "42796959" order code

    Scenario: Payment authorization with negative dynamic3DS triggers a normal authorized reply
        When I authorize the following payment
            | merchantCode        | SESSIONECOM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | orderCode           | 42796959                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
            | description         | some description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
            | currencyCode        | GBP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | value               | 15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | encryptedData       | eyJhbGciOiJSU0ExXzUiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoiMSIsImNvbS53b3JsZHBheS5hcGlWZXJzaW9uIjoiMS4wIiwiY29tLndvcmxkcGF5LmxpYlZlcnNpb24iOiIxLjAuMSIsImNvbS53b3JsZHBheS5jaGFubmVsIjoiamF2YXNjcmlwdCJ9.UH4Y2v2KbW2DdvRD7YHdTIJUggsvXII7ELtHR8j2DlcCrGOEMNct6ldhyXaPyFJzAzHT36egehOjOTEwkFLJdmpow_HF1J0gpbzptbGA8sM2m7s6jcPmrTbKFefm__4J2DjMXgky1ePK4dLUBVnA3VlElSykSUi1IqCoJwP7jVyIG6i02mIg7FNRAeoV41KqTtKzCkgm7mXKtymUUZnLlX4RGnuyHDA6qFCN1lAOods_z55bSfwAKaJv6Yv0VWuHRpzFS1UjUcPOC6ykCDD6avLzyNldMVD2n52nw6JGwaB_0R0QdbcGC_apbqxnd7Uh6jSkN5vRxzR_6x9cvSUM7A.SEuHD3wTOA9m16DZ.DyOT__yg46O6tXPjO1qa6LxUHg-Q2EubPpSgw4kwr0v79_4rouOa3PN4n-638nTi0qd07EEn0RfKzW8sbBbxiJJP73fUtwdp5N4_frt72u6DSjnXQnV85Nkx9p5zapOvpXoNZ18W02moKw._YWDBgZNMCZiqsJFshUhQg |
            | firstName           | Tim                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
            | lastName            | Webster                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | address1            | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | address2            | Braford Gardens                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | address3            | Shenley Brook End                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | postalCode          | MK137QJ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
            | city                | Milton Keynes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
            | state               | Buckingamshire                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
            | countryCode         | GB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | shopperIPAddress    | 123.123.123.123                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
            | sessionId           | 0215ui8ib1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | email               | lpanainte+test@inviqa.com                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | acceptHeader        | text/html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
            | userAgentHeader     | Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | dynamic3DS          | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | RGProfileID         | 201477                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | shippingMethod      | UK Next Day                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
            | checkoutMethod      | Registered                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
            | orderSource         | Store                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | ageOfAccount        | 4.5678                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | timeSinceLastOrder  | 3.4567                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
            | numberPurchases     | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | productRisk         | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
            | numberStyles        | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberSkus          | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberUnits         | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | numberHighRiskUnits | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
        Then I should receive an authorised response
        And the response should be successful
        And the response should reference the "42796959" order code

    Scenario: 3D Secure payment authorisation completion
        When the authorization for the following payment is completed
            | merchantCode | SESSIONECOM                                                                                                                                                                                                                                                                                                                                                                                                                                              |
            | orderCode    | reiss-9mar-2                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | paResponse   | eJx9UsFuwjAMve8rqt4haaGjIGPUqSD1AEKjk3atWqtEoi1LWsT+fklga7dp8yXx87P97ARW1+rkXEgq0dRL1xtz16E6bwpRl0v3Jd2MQneFkB4lUXygvJOEsCWlspIcUeiMwOfB3A+92dTzXIR99Ezqd2SsRFlToQn3XqhbjX1gn64uKvNjVrcIWf72lOzQ6w3YHYOKZBIPQ8ZGPe8WB9ZX23fmprTsqygwif60JTDDgCJrCX3uhXzC547HF8FkMZkBszicTbmoajpd2w84BzZEQC9I6v29Y+g/AvvygK7npiaTA+zrDqwXt492yAd2G8egkL4itKL6IWq6MM0tDqrN2k5hEq93abJJ1jGwOwR5drng9t+pLQUoF8gDrU6fNis6lY0U7bEymr8DwIwmZt8a4aCfVjeTxOzi7d8wlOGfefgAZo27+w== |
            | sessionId    | sessionliviu                                                                                                                                                                                                                                                                                                                                                                                                                                             |
            | cookie       | machine=0aa20016;path=/                                                                                                                                                                                                                                                                                                                                                                                                                                  |
        Then I should receive an authorised response
        And the response should be successful
        And the response should reference the "reiss-9mar-2" order code

    Scenario: Failed 3D Secure payment authorisation completion
        When the authorization for the following payment is completed
            | merchantCode | SESSIONECOM             |
            | orderCode    | reiss-9mar-2            |
            | paResponse   | trigger-an-error        |
            | sessionId    | sessionliviu            |
            | cookie       | machine=0aa20016;path=/ |
        Then I should receive an authorised response
        And the response should not be successful
        And the response error message should be "An internal CSE service error has occurred."
        And the response error code should be "5"
